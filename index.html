<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Network Impact Map | Dashboard</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add Bootstrap JS and CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: 360px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: #3b82f6;
        }

        /* Filter Cards */
        .filter-card {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .filter-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .filter-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .select-wrapper {
            position: relative;
            margin-bottom: 16px;
        }

        .select-wrapper i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 14px;
            z-index: 1;
        }

        select {
            width: 100%;
            padding: 12px 16px 12px 40px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover,
        select:focus {
            border-color: #3b82f6;
            outline: none;
        }

        /* ========== MULTI-SELECT DROPDOWN STYLES ========== */
        .multi-select-container {
            position: relative;
            width: 100%;
        }

        .multi-select-header {
            padding: 12px 16px 12px 40px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .multi-select-header:hover {
            border-color: #3b82f6;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            margin-top: 5px;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-search {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .dropdown-search i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 14px;
        }

        .dropdown-search input {
            width: 100%;
            padding: 8px 35px 8px 35px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .dropdown-search input:focus {
            border-color: #3b82f6;
            outline: none;
        }

        .clear-search {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 12px;
            padding: 2px;
        }

        .clear-search:hover {
            color: #ef4444;
        }

        .dropdown-actions {
            display: flex;
            padding: 8px 12px;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .select-all {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .select-all:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .clear-all {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .clear-all:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .sector-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .sector-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sector-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .sector-item input {
            margin-right: 10px;
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }

        .sector-item label {
            flex: 1;
            cursor: pointer;
            font-size: 13px;
            color: #e2e8f0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sector-item.selected {
            background: rgba(59, 130, 246, 0.15);
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #94a3b8;
            font-size: 13px;
        }

        /* Multi-select dropdown scrollbar */
        .multi-select-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .multi-select-dropdown::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }

        .multi-select-dropdown::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: #cbd5e1;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        /* Stats */
        .stats-container {
            margin-top: 24px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ========== MAP ========== */
        .map-container {
            flex: 1;
            height: 100vh;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
        }

        .control-btn:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: #3b82f6;
            color: #3b82f6;
            transform: translateY(-2px);
        }

        /* Category Color Legend */
        .category-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            width: 220px;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .legend-label {
            font-size: 13px;
            color: #94a3b8;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 320px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            .map-container {
                height: 50vh;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .multi-select-dropdown {
                position: fixed;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%);
                width: 90vw;
                max-width: 400px;
                max-height: 60vh;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        /* Loading animation */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="app-container d-flex flex-column flex-md-row">
        <!-- Sidebar -->
        <div class="sidebar col-12 col-md-3">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-globe-europe"></i>
                    </div>
                    <div class="logo-text">Reseller Location Map</div>
                </div>
            </div>

            <div class="sidebar-content">
                <div class="filter-card">
                    <h3 class="section-title">
                        <i class="fas fa-filter"></i> Filter Stores
                    </h3>

                    <!-- Business Sector (NAME) Filter - Multi-Select Dropdown -->
                    <div class="select-wrapper">
                        <i class="fas fa-user-tie"></i>
                        <div class="multi-select-container">
                            <div class="multi-select-header" onclick="toggleMultiSelect()">
                                <span id="selected-count">All Stores (0 selected)</span>
                                <i class="fas fa-chevron-down" id="dropdown-icon"></i>
                            </div>

                            <div class="multi-select-dropdown" id="sectorDropdown" style="display: none;">
                                <!-- Search Box inside dropdown -->
                                <div class="dropdown-search">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="sectorSearch" placeholder="Search business sectors..."
                                        oninput="searchSectors()" onkeydown="handleSearchKeydown(event)">
                                    <button class="clear-search" onclick="clearSearch()" title="Clear search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <!-- Select All / Clear All buttons -->
                                <div class="dropdown-actions">
                                    <button class="action-btn select-all" onclick="selectAllSectors()">
                                        Select All
                                    </button>
                                    <button class="action-btn clear-all" onclick="clearAllSectors()">
                                        Clear All
                                    </button>
                                </div>

                                <!-- Sector list -->
                                <div class="sector-list" id="sectorList">
                                    <!-- Options will be populated from data -->
                                </div>
                            </div>
                        </div>

                        <!-- Hidden original select for compatibility -->
                        <select id="sectorFilter" style="display: none;" multiple>
                            <option value="all" selected>All Stores</option>
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div class="select-wrapper">
                        <i class="fas fa-tags"></i>
                        <select id="categoryFilter">
                            <option value="all">All Categories</option>
                            <!-- Options will be populated from data -->
                        </select>
                    </div>
                </div>

                <div class="filter-card">
                    <h3 class="section-title">
                        <i class="fas fa-chart-line"></i> Quick Stats
                    </h3>

                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-value" id="totalClients">0</div>
                            <div class="stat-label">Total Stores</div>
                        </div>
                    </div>
                </div>

                <div class="btn-group d-flex flex-column flex-md-row">
                    <button class="btn btn-secondary mb-2 mb-md-0" onclick="resetFilters()">
                        <i class="fas fa-redo"></i> Reset Filters
                    </button>
                    <button class="btn btn-primary" onclick="exportCSV()">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container col-12 col-md-9">
            <!-- Loading overlay -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
            </div>

            <div id="map"></div>

            <!-- Map Controls -->
            <div class="map-controls">
                <div class="control-btn" onclick="map.zoomIn()">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="control-btn" onclick="map.zoomOut()">
                    <i class="fas fa-minus"></i>
                </div>
                <div class="control-btn" onclick="toggleLegend()">
                    <i class="fas fa-layer-group"></i>
                </div>
            </div>

            <!-- Category Color Legend -->
            <div class="category-legend" id="categoryLegend">
                <div class="legend-title">
                    <i class="fas fa-palette"></i>Categories
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #002395;"></div>
                    <div class="legend-label">French Reseller</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FF5800;"></div>
                    <div class="legend-label">International Reseller</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // ================= MAP INITIALIZATION =================
        const map = L.map('map').setView([46.603354, 1.888334], 6);

        // OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        let geoLayer, geoData;
        let allSectorOptions = []; // Store all sector names for filtering
        let allCategories = []; // Store all category names
        let selectedSectors = new Set(); // Track selected sectors

        // ================= LOADING OVERLAY =================
        const loadingOverlay = document.getElementById('loadingOverlay');

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                loadingOverlay.style.opacity = '1';
            }, 300);
        }

        // Show loading initially
        showLoading();

        // ========== SAFE PROPERTY ACCESS ==========
        function getProp(p, keys) {
            for (let k of keys) {
                if (p[k] !== undefined && p[k] !== null && p[k] !== "" && p[k] !== " ") {
                    return p[k];
                }
            }
            return "N/A";
        }

        // Get Business Sector NAME
        function getBusinessSector(p) {
            return getProp(p, ["NAME", "Name", "Nom", "Nom de la boutique", "Retailer_Name"]);
        }

        // Get Category
        function getCategory(p) {
            return getProp(p, [
                "Category", "Catégorie", "Type", "Client_Zone", "Client Zone",
                "Zone", "Client_Type", "Client Type", "Classification"
            ]);
        }

        // Get Sales Impact
        function getSalesImpact(p) {
            const impact = getProp(p, [
                "Sales_Impact_Clean", "Sales Impact", "Impact", "Revenue",
                "Client Value", "Client_Value", "ClientValue"
            ]);

            if (impact === "N/A") return 0;

            // Convert to number, remove currency symbols
            const num = parseFloat(impact.toString().replace(/[€$,]/g, ''));
            return isNaN(num) ? 0 : num;
        }

        // ========== CATEGORY COLORS ==========
        function getCategoryColor(category) {
            if (!category || category === "N/A") return "#8B4513"; // Brown for others

            category = category.toLowerCase();

            // French Blue for French categories
            if (category.includes("french") || category.includes("france") ||
                category.includes("paris") || category.includes("lyon") ||
                category.includes("marseille") || category.includes("toulouse") ||
                category === "fr" || category === "french") {
                return "#002395"; // French Blue
            }

            // International Orange for International categories
            if (category.includes("international") || category.includes("global") ||
                category.includes("world") || category.includes("europe") ||
                category.includes("usa") || category.includes("uk") ||
                category.includes("germany") || category.includes("spain") ||
                category.includes("italy")) {
                return "#FF5800"; // International Orange

            }

            // Default brown for other categories
            return "#8B4513";
        }

        // ========== SECTOR COLORS ==========
function getSectorColor(sector) {
    if (!sector || sector === "N/A") return "#8B4513";
    
    // Create a more unique hash
    let hash = 0;
    for (let i = 0; i < sector.length; i++) {
        const char = sector.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & 0xFFFFFFFF; // Ensure 32-bit
    }
    
    // Predefined color palette for better distinction
    const colorPalette = [
        "#000000", "#FF0000", "#0000FF", "#008000", "#FFA500", "#800080", "#00FFFF", "#FF1493", "#8B4513", "#808000",
"#00CED1", "#FFD700", "#DC143C", "#2F4F4F", "#FF4500", "#1E90FF", "#32CD32", "#FF69B4", "#4B0082", "#A52A2A",
"#20B2AA", "#B8860B", "#9932CC", "#4682B4", "#ADFF2F", "#CD5C5C", "#6A5ACD", "#F08080", "#008B8B", "#B22222",
"#7FFF00", "#FF8C00", "#9400D3", "#00BFFF", "#228B22", "#C71585", "#556B2F", "#DAA520", "#483D8B"
    ];
    
    // Use hash to pick from palette
    const index = Math.abs(hash) % colorPalette.length;
    return colorPalette[index];
}

        function getRadius(value) {
            if (!value || value === 0) return 6;
            if (value > 100000) return 16;
            if (value > 50000) return 12;
            if (value > 10000) return 9;
            return 6;
        }

        // ========== MULTI-SELECT FUNCTIONS ==========
        function toggleMultiSelect() {
            const dropdown = document.getElementById('sectorDropdown');
            const icon = document.getElementById('dropdown-icon');

            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                // Focus search input when dropdown opens
                setTimeout(() => {
                    document.getElementById('sectorSearch').focus();
                }, 100);
            } else {
                dropdown.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function populateSectorList() {
    const sectorList = document.getElementById('sectorList');
    sectorList.innerHTML = '';

    // Filter sectors based on search
    const searchTerm = document.getElementById('sectorSearch').value.toLowerCase();
    let filteredSectors = allSectorOptions;

    if (searchTerm) {
        filteredSectors = allSectorOptions.filter(sector =>
            sector.toLowerCase().includes(searchTerm)
        );
    }

    if (filteredSectors.length === 0) {
        sectorList.innerHTML = '<div class="no-results">No matching sectors found</div>';
        return;
    }

    filteredSectors.forEach(sector => {
        const isSelected = selectedSectors.has(sector);
        // Yeh line add karo - har sector ke liye color generate karo
        const sectorColor = getSectorColor(sector); // <-- YEH LINE ADD KARO

        const item = document.createElement('div');
        item.className = `sector-item ${isSelected ? 'selected' : ''}`;
        item.innerHTML = `
            <div class="sector-color-indicator" style="background-color: ${sectorColor}; width: 12px; height: 12px; border-radius: 50%; margin-right: 10px;"></div>
            <input type="checkbox" id="sector_${sector.replace(/[^a-zA-Z0-9]/g, '_')}" 
                   ${isSelected ? 'checked' : ''} 
                   onchange="toggleSector('${sector.replace(/'/g, "\\'")}')">
            <label for="sector_${sector.replace(/[^a-zA-Z0-9]/g, '_')}" title="${sector}">
                ${sector}
            </label>
        `;
        sectorList.appendChild(item);
    });
}

        function searchSectors() {
            populateSectorList();
        }

        function clearSearch() {
            document.getElementById('sectorSearch').value = '';
            searchSectors();
        }

        function handleSearchKeydown(event) {
            // Close dropdown on Escape key
            if (event.key === 'Escape') {
                toggleMultiSelect();
            }
            // Prevent event bubbling
            event.stopPropagation();
        }

        function toggleSector(sector) {
            if (selectedSectors.has(sector)) {
                selectedSectors.delete(sector);
            } else {
                selectedSectors.add(sector);
            }

            updateSelectedCount();
            populateSectorList();
            applyFilters();
        }

        function selectAllSectors() {
            const searchTerm = document.getElementById('sectorSearch').value.toLowerCase();

            if (searchTerm) {
                // Select only filtered sectors
                allSectorOptions.forEach(sector => {
                    if (sector.toLowerCase().includes(searchTerm)) {
                        selectedSectors.add(sector);
                    }
                });
            } else {
                // Select all sectors
                allSectorOptions.forEach(sector => {
                    selectedSectors.add(sector);
                });
            }

            updateSelectedCount();
            populateSectorList();
            applyFilters();
        }

        function clearAllSectors() {
            const searchTerm = document.getElementById('sectorSearch').value.toLowerCase();

            if (searchTerm) {
                // Clear only filtered sectors
                allSectorOptions.forEach(sector => {
                    if (sector.toLowerCase().includes(searchTerm)) {
                        selectedSectors.delete(sector);
                    }
                });
            } else {
                // Clear all sectors
                selectedSectors.clear();
            }

            updateSelectedCount();
            populateSectorList();
            applyFilters();
        }

        function updateSelectedCount() {
            const count = selectedSectors.size;
            const total = allSectorOptions.length;
            const countElement = document.getElementById('selected-count');

            if (count === 0) {
                countElement.textContent = 'All Stores (0 selected)';
            } else if (count === total) {
                countElement.textContent = `All Stores (${count}/${total})`;
            } else {
                countElement.textContent = `${count} sector${count > 1 ? 's' : ''} selected`;
            }
        }

        // ========== UPDATE STATS ==========
        function updateStats(data) {
            const features = data.features;

            // Total records in CURRENT filtered data
            const filteredRecords = features.length;

            // Agar original total chahiye (filter se pehle)
            const originalTotal = geoData ? geoData.features.length : 0;

            // Display filtered count
            document.getElementById('totalClients').textContent = filteredRecords;

            // Ya phir filtered/original format mein:
            // document.getElementById('totalClients').textContent = `${filteredRecords}/${originalTotal}`;
        }
        // ========== LOAD GEOJSON ==========
        function loadGeoData() {
            // First try France.geojson, then new.geojson
            fetch("France.geojson")
                .then(r => {
                    if (r.ok) return r.json();
                    throw new Error('France.geojson not found');
                })
                .then(data => {
                    console.log("Data loaded from France.geojson:", data.features.length, "points");
                    processData(data);
                })
                .catch(error => {
                    console.log("Trying new.geojson...");
                    fetch("new.geojson")
                        .then(r => {
                            if (r.ok) return r.json();
                            throw new Error('new.geojson also not found');
                        })
                        .then(data => {
                            console.log("Data loaded from new.geojson:", data.features.length, "points");
                            processData(data);
                        })
                        .catch(error2 => {
                            console.log("Both files not found, creating demo data");
                            createDemoData();
                        });
                });
        }

        function processData(data) {
            geoData = data;

            // Extract all unique sectors and categories
            const sectorsSet = new Set();
            const categoriesSet = new Set();

            data.features.forEach(f => {
                const p = f.properties;
                const sector = getBusinessSector(p);
                const category = getCategory(p);

                if (sector !== "N/A") sectorsSet.add(sector);
                if (category !== "N/A") categoriesSet.add(category);
            });

            allSectorOptions = Array.from(sectorsSet).sort();
            allCategories = Array.from(categoriesSet).sort();

            // Initialize selected sectors to all
            selectedSectors = new Set(allSectorOptions);

            populateMultiSelectFilters();
            drawMap(data);
            autoZoomToFitPoints(data);
            hideLoading();
        }

        function populateMultiSelectFilters() {
            // Populate multi-select dropdown
            populateSectorList();
            updateSelectedCount();

            // Update original category filter (single select)
            const categoryFilter = document.getElementById('categoryFilter');
            while (categoryFilter.options.length > 1) categoryFilter.remove(1);

            allCategories.forEach(c => {
                if (c !== "N/A") {
                    const option = document.createElement('option');
                    option.value = c;
                    option.textContent = c;
                    categoryFilter.appendChild(option);
                }
            });
        }

        // ========== CREATE DEMO DATA ==========
        function createDemoData() {
            const demoFeatures = [];
            const sectors = ["Retail Store Paris", "Fashion Boutique Lyon", "Food Market Marseille",
                "Tech Company Lille", "Manufacturing Plant Toulouse", "Healthcare Center Nice",
                "Bank Paris", "Hotel Monaco", "Restaurant Bordeaux", "University Strasbourg"];
            const categories = ["French Client", "International Client", "French", "International", "Other Category"];

            // Generate 50 random points across France
            for (let i = 1; i <= 50; i++) {
                // Random coordinates within France
                const lat = 46.0 + Math.random() * 4 - 2;
                const lng = 2.0 + Math.random() * 6 - 3;

                const sector = sectors[Math.floor(Math.random() * sectors.length)];
                const category = categories[Math.floor(Math.random() * categories.length)];
                const value = Math.floor(Math.random() * 200000) + 10000;

                demoFeatures.push({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [lng, lat]
                    },
                    properties: {
                        "Retailer_Name": `Client ${i} - ${sector}`,
                        "Name": `Client ${i}`,
                        "Business Sector": sector,
                        "Category": category,
                        "Client Value": value.toString(),
                        "Sales Impact Clean": Math.floor(value * 0.1).toString(),
                        "Full Address": `Demo Address ${i}, France`
                    }
                });
            }

            geoData = {
                type: "FeatureCollection",
                features: demoFeatures
            };

            processData(geoData);
        }

        // ========== DRAW MAP ==========
function drawMap(data) {
    // Remove existing layers
    if (geoLayer) map.removeLayer(geoLayer);

    // Get current filter values
    const selectedCategory = document.getElementById('categoryFilter').value;

    // Filter features
    const filteredFeatures = data.features.filter(f => {
        const p = f.properties;
        const sector = getBusinessSector(p);
        const category = getCategory(p);

        // Multi-select sector filter logic
        const sectorMatch = selectedSectors.size === 0 ||
            selectedSectors.has(sector) ||
            (selectedSectors.size === allSectorOptions.length && allSectorOptions.length > 0);

        // Single select category filter
        const categoryMatch = (selectedCategory === "all" || category === selectedCategory);

        return sectorMatch && categoryMatch;
    });

    const filteredData = {
        ...data,
        features: filteredFeatures
    };

    // Create new geo layer
    geoLayer = L.geoJSON(filteredData, {
        pointToLayer: (feature, latlng) => {
            const p = feature.properties;
            const category = getCategory(p);
            const sector = getBusinessSector(p); // <-- Sector bhi le rahe hain
            const value = getSalesImpact(p);

            // DECISION: Agar "All Categories" hai to sector color, warna category color
            let fillColor;
            if (selectedCategory === "all") {
                // Default: Sector colors
                fillColor = getSectorColor(sector);
            } else {
                // Category filter lagaya hai: Category colors
                fillColor = getCategoryColor(category);
            }

            return L.circleMarker(latlng, {
                radius: getRadius(value),
                fillColor: fillColor, // <-- Dynamic color based on filter
                color: "#ffffff",
                weight: 1.5,
                opacity: 0.9,
                fillOpacity: 0.85
            });
        },

        onEachFeature: (feature, layer) => {
            const p = feature.properties;
            
            // Define which fields to show and their display names
            const fieldsToShow = [
                { key: 'Store Name', displayName: 'Store Name' },
                { key: 'Category', displayName: 'Category' },
                { key: 'Address', displayName: 'Address' },
                { key: 'INDUSTRY', displayName: 'Industry' },
                { key: 'CUST_ACCT', displayName: 'Customer Account' },
                { key: 'PHONE_DIR', displayName: 'Phone Directory' },
                { key: 'ZIP_CODE', displayName: 'Zip Code' },
                { key: 'CITY', displayName: 'City' },
                { key: 'E_MAIL', displayName: 'Email' }
                // MEASURE field is intentionally NOT included here
            ];
            
            let detailsHTML = '';
            
            fieldsToShow.forEach(field => {
                const value = p[field.key];
                if (value !== null && value !== undefined && value !== '' && value !== ' ' && value !== 'N/A') {
                    detailsHTML += `<p><strong>${field.displayName}:</strong> ${value}</p>`;
                }
            });
            
            layer.bindPopup(`
                <div class="popup-content">
                    <h3>${getBusinessSector(p)}</h3>
                    <div class="popup-details">
                        ${detailsHTML}
                    </div>
                </div>
            `, {
                className: 'custom-popup',
                maxWidth: 300
            });
            
            // Add hover effect
            layer.on('mouseover', function () {
                this.setStyle({
                    weight: 2.5,
                    color: '#ffffff',
                    fillOpacity: 1
                });
            });
            
            layer.on('mouseout', function () {
                this.setStyle({
                    weight: 1.5,
                    color: '#ffffff',
                    fillOpacity: 0.85
                });
            });
        }
    }).addTo(map);

    // Update stats with filtered data
    updateStats(filteredData);

    // Auto zoom to show all points
    if (filteredFeatures.length > 0) {
        const bounds = geoLayer.getBounds();
        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
        }
    }
}

        // ========== AUTO ZOOM ==========
        function autoZoomToFitPoints(data) {
            if (!data || !data.features || data.features.length === 0) return;

            // Create temporary layer to get bounds
            const tempLayer = L.geoJSON(data, {
                pointToLayer: (feature, latlng) => L.marker(latlng)
            });

            const bounds = tempLayer.getBounds();
            if (bounds.isValid()) {
                // Fit bounds with padding and limit max zoom
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 12,
                    animate: true
                });
            }
        }

        // ========== EXPORT CSV FUNCTION ==========
        function exportCSV() {
            if (!geoData) {
                alert("No data available to export.");
                return;
            }

            // Get filtered data
            const selectedCategory = document.getElementById('categoryFilter').value;

            const filteredFeatures = geoData.features.filter(f => {
                const p = f.properties;
                const sector = getBusinessSector(p);
                const category = getCategory(p);

                // Multi-select sector filter
                const sectorMatch = selectedSectors.size === 0 ||
                    selectedSectors.has(sector) ||
                    (selectedSectors.size === allSectorOptions.length && allSectorOptions.length > 0);

                // Single select category filter
                const categoryMatch = (selectedCategory === "all" || category === selectedCategory);

                return sectorMatch && categoryMatch;
            });

            if (filteredFeatures.length === 0) {
                alert("No data to export based on current filters.");
                return;
            }

            // Create CSV content
            const headers = [
                "Business Sector Name",
                "Category",
                "Revenue (€)",
                "Sales Impact",
                "Address",
                "City",
                "Postal Code",
                "Country",
                "Latitude",
                "Longitude"
            ];

            let csvContent = headers.join(",") + "\n";

            filteredFeatures.forEach(feature => {
                const p = feature.properties;
                const geometry = feature.geometry;

                const sector = getBusinessSector(p);
                const category = getCategory(p);
                const revenue = getSalesImpact(p);
                const salesImpact = getProp(p, ["Sales_Impact_Clean", "Sales Impact"]);
                const address = getProp(p, ["Full Address", "Full_Address", "Address"]);
                const city = getProp(p, ["City", "Ville"]);
                const postalCode = getProp(p, ["Postal_Code", "Code_postal"]);
                const country = getProp(p, ["Country", "Pays"]);
                const lat = geometry.coordinates[1] || "";
                const lng = geometry.coordinates[0] || "";

                const row = [
                    `"${sector.replace(/"/g, '""')}"`,
                    `"${category.replace(/"/g, '""')}"`,
                    revenue,
                    salesImpact,
                    `"${address.replace(/"/g, '""')}"`,
                    `"${city.replace(/"/g, '""')}"`,
                    `"${postalCode}"`,
                    `"${country.replace(/"/g, '""')}"`,
                    lat,
                    lng
                ];

                csvContent += row.join(",") + "\n";
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `client_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ========== INTERACTION FUNCTIONS ==========
        function applyFilters() {
            if (geoData) {
                drawMap(geoData);
            }
        }

        function resetFilters() {
            selectedSectors = new Set(allSectorOptions);
            document.getElementById('categoryFilter').value = "all";
            document.getElementById('sectorSearch').value = '';
            updateSelectedCount();
            populateSectorList();

            if (geoData) {
                drawMap(geoData);
            }
        }

        function resetView() {
            map.setView([46.603354, 1.888334], 6);
        }

        function toggleLegend() {
            const legend = document.getElementById('categoryLegend');
            legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
        }

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', function () {
            // Add event listeners to filters
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);

            // Close dropdown when clicking outside
            document.addEventListener('click', function (event) {
                const dropdown = document.getElementById('sectorDropdown');
                const header = document.querySelector('.multi-select-header');

                if (dropdown && header && !dropdown.contains(event.target) && !header.contains(event.target)) {
                    dropdown.style.display = 'none';
                    document.getElementById('dropdown-icon').className = 'fas fa-chevron-down';
                }
            });

            // Load data after a short delay to show loading animation
            setTimeout(loadGeoData, 800);

            // Add custom popup styles
            const style = document.createElement('style');
            style.textContent = `
                .custom-popup .leaflet-popup-content-wrapper {
                    background: rgba(15, 23, 42, 0.95);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 12px;
                    color: #e2e8f0;
                }
                .custom-popup .leaflet-popup-content {
                    margin: 12px 16px;
                    line-height: 1.5;
                }
                .custom-popup h3 {
                    margin-bottom: 8px;
                    color: #3b82f6;
                    font-size: 16px;
                }
                .custom-popup .popup-details p {
                    margin: 6px 0;
                    font-size: 14px;
                }
                .custom-popup .value {
                    color: #10b981;
                    font-weight: 600;
                }
                .custom-popup .impact {
                    color: #f59e0b;
                    font-weight: 600;
                }
                .custom-popup .address {
                    font-size: 12px;
                    color: #94a3b8;
                    margin-top: 10px;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    padding-top: 10px;
                }
                .custom-popup .leaflet-popup-tip {
                    background: rgba(15, 23, 42, 0.95);
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>

</html>